name: PEP 8 Compliance Check

on:
  push:
    branches:
      - '**'  # Run on pushes to any branch

jobs:
  pep8_check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # IMPORTANT: Fetch all history for git diff to work correctly

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x' # Specify your Python version (e.g., '3.9', '3.10', '3.11')

    - name: Install flake8
      run: pip install flake8

    - name: Get changed Python files
      id: changed-files
      run: |
        # For push events, compare with the previous commit
        CHANGED_PYTHON_FILES=$(git diff --name-only --diff-filter=ACM ${{ github.event.before }} ${{ github.sha }} | grep '\.py$' | tr '\n' ' ')
        echo "changed_python_files=${CHANGED_PYTHON_FILES}" >> $GITHUB_OUTPUT
      shell: bash

    - name: Run flake8 on changed Python files
      if: success() && steps.changed-files.outputs.changed_python_files
      run: |
        echo "Checking the following files for PEP 8 compliance:"
        echo "${{ steps.changed-files.outputs.changed_python_files }}"
        echo ""
        # Use xargs to properly handle multiple files
        echo "${{ steps.changed-files.outputs.changed_python_files }}" | xargs flake8
      shell: bash

    - name: Report success if no Python files were changed (Optional, for clarity)
      # This step only runs if the 'Run flake8' step was skipped due to no Python files being found.
      # It provides a clear message in the GitHub Actions UI.
      if: success() && !steps.changed-files.outputs.changed_python_files
      run: echo "No .py files changed in this push. PEP 8 compliance check passed (skipped)."